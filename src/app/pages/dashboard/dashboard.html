<div class="dashboard">
  <!-- Metric Cards -->
  <div class="metric-cards">
    @for (card of metricCards; track card.title) {
      <div class="metric-card" [style.background]="card.bgColor">
        <div class="metric-content">
          <div class="metric-icon">
            <i [class]="card.icon" [style.color]="card.color"></i>
          </div>
          <div class="metric-details">
            <div class="metric-title" [style.color]="card.color">{{ card.title }}</div>
            <div class="metric-value" [style.color]="card.color">{{ card.value }}</div>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Controls Section -->
  <div class="content-section energy-section">
    <div class="section-header">
      <div class="section-info">
        <h3>Energy Dashboard</h3>
        <p>Solar production and grid energy data monitoring system</p>
      </div>
      <div class="data-selector">
        <button class="token-btn" (click)="changeToken()" [disabled]="appState.loading.isLoading" title="Change API Token">
          <i class="pi pi-key"></i>
          <span>Token</span>
        </button>
      </div>
    </div>

    <!-- Token Status -->
    @if (!hasValidToken) {
      <div class="warning-message">
        <i class="pi pi-exclamation-triangle"></i>
        <span>API token required. Click "Token" button to set your X-Global-Home-Token.</span>
      </div>
    }
    
    <!-- Error Message -->
    @if (appState.error) {
      <div class="error-message">
        <i class="pi pi-exclamation-triangle"></i>
        <span>{{ appState.error }}</span>
      </div>
    }
  </div>

    <!-- Daily Energy Data Section - Grouped Charts -->
  <div class="content-section energy-section">
    <div class="section-header">
      <div class="section-info">
        <h3>📊 Daily Energy Data</h3>
        <p>Daily solar production, grid energy flow, and plant efficiency metrics - {{ currentDateDisplayText }}</p>
        @if (appState.showRefreshReminder) {
          <div class="refresh-reminder">
            <i class="pi pi-exclamation-triangle" style="color: #f59e0b; margin-right: 6px;"></i>
            <span style="color: #f59e0b; font-size: 0.875rem; font-weight: 500;">Data may not match selected month - Click refresh to update charts</span>
          </div>
        }
      </div>
      <div class="data-selector">
        <p-datepicker 
          [(ngModel)]="appState.selectedDate" 
          (ngModelChange)="onDatePickerChange($event)"
          view="month" 
          dateFormat="mm/yy" 
          [readonlyInput]="true"
          [disabled]="appState.loading.isLoading"
          placeholder="Select Month/Year"
          class="month-year-picker"
          [showIcon]="true"
          iconDisplay="input"
          title="Select Month and Year">
        </p-datepicker>
        <button class="refresh-btn" (click)="refreshData()" [disabled]="appState.loading.isLoading" title="Refresh All Daily Data">
          <i class="pi" [class.pi-refresh]="!appState.loading.isLoading" [class.pi-spin]="appState.loading.isLoading" [class.pi-spinner]="appState.loading.isLoading"></i>
          <span>{{ appState.loading.isLoading ? 'Loading...' : 'Refresh All' }}</span>
        </button>
      </div>
    </div>

    <!-- Inverter Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>☀️ Solar Production</h4>
          <p>Daily solar energy production from inverter</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshInverterData()" [disabled]="appState.loading.isInverterLoading" title="Refresh Inverter Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isInverterLoading" [class.pi-spin]="appState.loading.isInverterLoading" [class.pi-spinner]="appState.loading.isInverterLoading"></i>
            <span>{{ appState.loading.isInverterLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (inverterChartData.datasets && inverterChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="inverterChartData"
              [options]="inverterChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Inverter data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Meter Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>⚡ Grid Energy Flow</h4>
          <p>Daily grid energy import/export measurements</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshMeterData()" [disabled]="appState.loading.isMeterLoading" title="Refresh Meter Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isMeterLoading" [class.pi-spin]="appState.loading.isMeterLoading" [class.pi-spinner]="appState.loading.isMeterLoading"></i>
            <span>{{ appState.loading.isMeterLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (meterChartData.datasets && meterChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="meterChartData"
              [options]="meterChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Meter data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Plant Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>🌿 Plant Overview</h4>
          <p>Daily plant energy flow and efficiency metrics</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshPlantData()" [disabled]="appState.loading.isPlantLoading" title="Refresh Plant Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isPlantLoading" [class.pi-spin]="appState.loading.isPlantLoading" [class.pi-spinner]="appState.loading.isPlantLoading"></i>
            <span>{{ appState.loading.isPlantLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (plantChartData.datasets && plantChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="plantChartData"
              [options]="plantChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Plant data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Daily Stats Section - Separate Group of Charts -->
  <div class="content-section energy-section">
    <div class="section-header">
      <div class="section-info">
        <h3>📈 Detailed Daily Statistics</h3>
        <p>Detailed METER and INVERTER daily statistics with custom date range - {{ detailedDateRangeText }}</p>
      </div>
      <div class="data-selector">
        <div class="date-range-picker">
          <label>Date Range:</label>
          <p-datepicker 
            [(ngModel)]="appState.detailedDateRange" 
            (ngModelChange)="onDetailedDateRangeChange($event)"
            selectionMode="range"
            dateFormat="dd/mm/yy" 
            [readonlyInput]="true"
            [disabled]="appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading"
            placeholder="Select Date Range"
            class="detail-date-picker range-picker"
            [showIcon]="true"
            iconDisplay="input"
            title="Select Date Range"
            [numberOfMonths]="2">
          </p-datepicker>
        </div>
        <button class="refresh-btn" (click)="refreshDetailedData()" [disabled]="appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading" title="Refresh Detailed Data">
          <i class="pi" [class.pi-refresh]="!appState.loading.isDetailedInverterLoading && !appState.loading.isDetailedMeterLoading" [class.pi-spin]="appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading" [class.pi-spinner]="appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading"></i>
          <span>{{ (appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading) ? 'Loading...' : 'Refresh Detailed' }}</span>
        </button>
      </div>
    </div>

    <!-- Detailed Inverter Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>☀️ Detailed INVERTER Data</h4>
          <p>Detailed daily solar energy production from inverter with date range</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshDetailedData()" [disabled]="appState.loading.isDetailedInverterLoading" title="Refresh Detailed Inverter Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isDetailedInverterLoading" [class.pi-spin]="appState.loading.isDetailedInverterLoading" [class.pi-spinner]="appState.loading.isDetailedInverterLoading"></i>
            <span>{{ appState.loading.isDetailedInverterLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (detailedInverterChartData.datasets && detailedInverterChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="detailedInverterChartData"
              [options]="detailedInverterChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Detailed inverter data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Detailed Meter Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>⚡ Detailed METER Data</h4>
          <p>Detailed daily grid energy import/export measurements with date range</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshDetailedData()" [disabled]="appState.loading.isDetailedMeterLoading" title="Refresh Detailed Meter Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isDetailedMeterLoading" [class.pi-spin]="appState.loading.isDetailedMeterLoading" [class.pi-spinner]="appState.loading.isDetailedMeterLoading"></i>
            <span>{{ appState.loading.isDetailedMeterLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (detailedMeterChartData.datasets && detailedMeterChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="detailedMeterChartData"
              [options]="detailedMeterChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Detailed meter data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>
  </div>

</div>
