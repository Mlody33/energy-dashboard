<div class="dashboard">
  <!-- Metric Cards -->
  <div class="metric-cards">
    @for (card of metricCards; track card.title) {
      <div class="metric-card" [style.background]="card.bgColor">
        <div class="metric-content">
          <div class="metric-icon">
            <i [class]="card.icon" [style.color]="card.color"></i>
          </div>
          <div class="metric-details">
            <div class="metric-title" [style.color]="card.color">{{ card.title }}</div>
            <div class="metric-value" [style.color]="card.color">{{ card.value }}</div>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Controls Section -->
  <div class="content-section energy-section">
    <div class="section-header">
      <div class="section-info">
        <h3>Energy Dashboard</h3>
        <p>Solar production and grid energy data monitoring system</p>
      </div>
      <div class="data-selector">
        <button class="token-btn" (click)="changeToken()" [disabled]="appState.loading.isLoading" title="Change API Token">
          <i class="pi pi-key"></i>
          <span>Token</span>
        </button>
      </div>
    </div>

    <!-- Token Status -->
    @if (!hasValidToken) {
      <div class="warning-message">
        <i class="pi pi-exclamation-triangle"></i>
        <span>API token required. Click "Token" button to set your X-Global-Home-Token.</span>
      </div>
    }
    
    <!-- Error Message -->
    @if (appState.error) {
      <div class="error-message">
        <i class="pi pi-exclamation-triangle"></i>
        <span>{{ appState.error }}</span>
      </div>
    }
  </div>

    <!-- Daily Energy Data Section - Grouped Charts -->
  <div class="content-section energy-section">
    <div class="section-header">
      <div class="section-info">
        <h3>📊 Daily Energy Data</h3>
        <p>Daily solar production, grid energy flow, and plant efficiency metrics - {{ currentDateDisplayText }}</p>
        @if (appState.showRefreshReminder) {
          <div class="refresh-reminder">
            <i class="pi pi-exclamation-triangle" style="color: #f59e0b; margin-right: 6px;"></i>
            <span style="color: #f59e0b; font-size: 0.875rem; font-weight: 500;">Data may not match selected month - Click refresh to update charts</span>
          </div>
        }
      </div>
      <div class="data-selector">
        <p-datepicker 
          [(ngModel)]="appState.selectedDate" 
          (ngModelChange)="onDatePickerChange($event)"
          view="month" 
          dateFormat="mm/yy" 
          [readonlyInput]="true"
          [disabled]="appState.loading.isLoading"
          placeholder="Select Month/Year"
          class="month-year-picker"
          [showIcon]="true"
          iconDisplay="input"
          title="Select Month and Year">
        </p-datepicker>
        <button class="refresh-btn" (click)="refreshData()" [disabled]="appState.loading.isLoading" title="Refresh All Daily Data">
          <i class="pi" [class.pi-refresh]="!appState.loading.isLoading" [class.pi-spin]="appState.loading.isLoading" [class.pi-spinner]="appState.loading.isLoading"></i>
          <span>{{ appState.loading.isLoading ? 'Loading...' : 'Refresh All' }}</span>
        </button>
      </div>
    </div>

    <!-- Inverter Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>☀️ Solar Production</h4>
          <p>Daily solar energy production from inverter</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshInverterData()" [disabled]="appState.loading.isInverterLoading" title="Refresh Inverter Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isInverterLoading" [class.pi-spin]="appState.loading.isInverterLoading" [class.pi-spinner]="appState.loading.isInverterLoading"></i>
            <span>{{ appState.loading.isInverterLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (inverterChartData.datasets && inverterChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="inverterChartData"
              [options]="inverterChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Inverter data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Meter Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>⚡ Grid Energy Flow</h4>
          <p>Daily grid energy import/export measurements and home usage</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshMeterData()" [disabled]="appState.loading.isMeterLoading" title="Refresh Meter Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isMeterLoading" [class.pi-spin]="appState.loading.isMeterLoading" [class.pi-spinner]="appState.loading.isMeterLoading"></i>
            <span>{{ appState.loading.isMeterLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (meterChartData.datasets && meterChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="meterChartData"
              [options]="meterChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Meter data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Plant Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>🌿 Plant Overview</h4>
          <p>Daily plant energy flow and efficiency metrics</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshPlantData()" [disabled]="appState.loading.isPlantLoading" title="Refresh Plant Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isPlantLoading" [class.pi-spin]="appState.loading.isPlantLoading" [class.pi-spinner]="appState.loading.isPlantLoading"></i>
            <span>{{ appState.loading.isPlantLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (plantChartData.datasets && plantChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="plantChartData"
              [options]="plantChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Plant data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Daily Stats Section - Separate Group of Charts -->
  <div class="content-section energy-section">
    <div class="section-header">
      <div class="section-info">
        <h3>📈 Detailed Daily Statistics</h3>
        <p>Detailed METER, INVERTER and PLANT daily statistics with custom date range - {{ detailedDateRangeText }}</p>
      </div>
      <div class="data-selector">
        <div class="date-range-picker">
          <label>Date Range:</label>
          <p-datepicker 
            [(ngModel)]="appState.detailedDateRange" 
            (ngModelChange)="onDetailedDateRangeChange($event)"
            selectionMode="range"
            dateFormat="dd/mm/yy" 
            [readonlyInput]="true"
            [disabled]="appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading || appState.loading.isDetailedPlantLoading"
            placeholder="Select Date Range"
            class="detail-date-picker range-picker"
            [showIcon]="true"
            iconDisplay="input"
            title="Select Date Range"
            [numberOfMonths]="2">
          </p-datepicker>
        </div>
        <button class="refresh-btn" (click)="refreshDetailedData()" [disabled]="appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading || appState.loading.isDetailedPlantLoading" title="Refresh Detailed Data">
          <i class="pi" [class.pi-refresh]="!appState.loading.isDetailedInverterLoading && !appState.loading.isDetailedMeterLoading && !appState.loading.isDetailedPlantLoading" [class.pi-spin]="appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading || appState.loading.isDetailedPlantLoading" [class.pi-spinner]="appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading || appState.loading.isDetailedPlantLoading"></i>
          <span>{{ (appState.loading.isDetailedInverterLoading || appState.loading.isDetailedMeterLoading || appState.loading.isDetailedPlantLoading) ? 'Loading...' : 'Refresh Detailed' }}</span>
        </button>
      </div>
    </div>

    <!-- Detailed Inverter Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>☀️ Detailed INVERTER Data</h4>
          <p>Detailed daily solar energy production from inverter with date range</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshDetailedInverterData()" [disabled]="appState.loading.isDetailedInverterLoading" title="Refresh Detailed Inverter Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isDetailedInverterLoading" [class.pi-spin]="appState.loading.isDetailedInverterLoading" [class.pi-spinner]="appState.loading.isDetailedInverterLoading"></i>
            <span>{{ appState.loading.isDetailedInverterLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (detailedInverterChartData.datasets && detailedInverterChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="detailedInverterChartData"
              [options]="detailedInverterChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Detailed inverter data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Detailed Meter Summary Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>⚡ Detailed METER Summary</h4>
          <p>Main energy totals - Grid Export, Grid Import, and Home Import</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshDetailedMeterData()" [disabled]="appState.loading.isDetailedMeterLoading" title="Refresh Detailed Meter Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isDetailedMeterLoading" [class.pi-spin]="appState.loading.isDetailedMeterLoading" [class.pi-spinner]="appState.loading.isDetailedMeterLoading"></i>
            <span>{{ appState.loading.isDetailedMeterLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 300px; width: 100%; position: relative;">
          @if (detailedMeterSummaryChartData.datasets && detailedMeterSummaryChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="detailedMeterSummaryChartData"
              [options]="detailedMeterSummaryChartOptions"
              [type]="chartType"
              width="800"
              height="300"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Detailed meter summary data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Detailed Meter CT Breakdown Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>⚡ Detailed METER CT Breakdown</h4>
          <p>Individual CT readings by floor: 🔌 CT1-3 Grid (1st Floor/2nd Floor/Basement), 🏠 CT4-6 Home (1st Floor/2nd Floor/Basement), plus Home Export</p>
        </div>
        <div class="subsection-actions">
          <button class="refresh-btn secondary" (click)="refreshDetailedMeterData()" [disabled]="appState.loading.isDetailedMeterLoading" title="Refresh Detailed Meter Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isDetailedMeterLoading" [class.pi-spin]="appState.loading.isDetailedMeterLoading" [class.pi-spinner]="appState.loading.isDetailedMeterLoading"></i>
            <span>{{ appState.loading.isDetailedMeterLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 450px; width: 100%; position: relative;">
          @if (detailedMeterChartData.datasets && detailedMeterChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="detailedMeterChartData"
              [options]="detailedMeterChartOptions"
              [type]="chartType"
              width="800"
              height="450"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Detailed meter CT breakdown data is being prepared...
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Detailed Plant Chart Subsection -->
    <div class="chart-subsection">
      <div class="subsection-header">
        <div class="subsection-info">
          <h4>🌿 Detailed PLANT Data</h4>
          <p>Plant energy breakdown as polar area chart - radial visualization showing production, consumption, and energy flow for {{ detailedPlantDateText }}</p>
        </div>
        <div class="subsection-actions">
          <div class="date-picker-inline">
            <label>Plant Date:</label>
            <p-datepicker 
              [(ngModel)]="appState.detailedPlantDate" 
              (ngModelChange)="onDetailedPlantDateChange($event)"
              dateFormat="dd/mm/yy" 
              [readonlyInput]="true"
              [disabled]="appState.loading.isDetailedPlantLoading"
              placeholder="Select Date"
              class="detail-date-picker single-date-picker"
              [showIcon]="true"
              iconDisplay="input"
              title="Select Plant Date">
            </p-datepicker>
          </div>
          <button class="refresh-btn secondary" (click)="refreshDetailedPlantData()" [disabled]="appState.loading.isDetailedPlantLoading" title="Refresh Detailed Plant Data">
            <i class="pi" [class.pi-refresh]="!appState.loading.isDetailedPlantLoading" [class.pi-spin]="appState.loading.isDetailedPlantLoading" [class.pi-spinner]="appState.loading.isDetailedPlantLoading"></i>
            <span>{{ appState.loading.isDetailedPlantLoading ? 'Loading...' : 'Refresh' }}</span>
          </button>
        </div>
      </div>

      <div class="chart-container-inner">
        <div class="chart-wrapper" style="height: 500px; width: 100%; position: relative;">
          @if (detailedPlantChartData && detailedPlantChartData.datasets && detailedPlantChartData.datasets.length > 0) {
            <canvas
              baseChart
              [data]="detailedPlantChartData"
              [options]="detailedPlantChartOptions"
              type="polarArea"
              width="800"
              height="500"
              style="display: block !important; width: 100% !important; height: 100% !important; border: none;">
            </canvas>
          } @else {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 1rem; background: #f9fafb; border-radius: 8px;">
              📊 Plant data is loading or no data available for selected date...
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Token Configuration Dialog -->
  <p-dialog 
    header="API Token Configuration" 
    [(visible)]="tokenDialogVisible" 
    [modal]="true" 
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="token-dialog"
    [style]="{width: '450px'}"
    (onHide)="cancelToken()">
    
    <div class="token-dialog-content">
      <p class="token-dialog-description">
        <i class="pi pi-info-circle"></i>
        Please enter your Global Home API Token (X-Global-Home-Token):
      </p>
      
      <div class="token-input-group">
        <label for="tokenInput" class="token-input-label">API Token:</label>
        <input 
          pInputText 
          id="tokenInput"
          type="password"
          [(ngModel)]="tokenInputValue" 
          placeholder="Enter your API token"
          class="token-input"
          autocomplete="off" />
      </div>
    </div>
    
    <ng-template pTemplate="footer">
      <div class="token-dialog-footer">
        <p-button 
          label="Cancel" 
          icon="pi pi-times" 
          [text]="true"
          severity="secondary"
          (onClick)="cancelToken()">
        </p-button>
        <p-button 
          label="Save" 
          icon="pi pi-check" 
          severity="success"
          (onClick)="saveToken()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

</div>
